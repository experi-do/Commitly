# Commitly 통합 PRD 

## 1. 문서 정보
- 버전: 0.3 (MVP 정리본)
- 작성일: 2025-10-21
- 작성자: Commitly 제품팀
- 배포 범위: 내부 개발 조직 공유

## 2. 서비스 개요
Commitly는 개발자의 Git 커밋 이후 전 과정을 자동화하는 로컬 전용 멀티 에이전트 파이프라인이다. CLI 또는 VS Code 확장으로 `commitly` 명령을 실행하면 Clone → Code → Test → Refactoring → Sync → Slack → Report 에이전트가 순차적으로 동작해 코드 실행, SQL 검증, 리팩토링, 배포 준비, 슬랙 공유, 보고서 생성까지 자동 처리한다. 최종 산출물은 JSON/Markdown 보고서와 Slack 메시지로 제공되며, 팀은 빠르게 변경 영향과 품질 상태를 확인할 수 있다.

## 3. 문제 정의
- 커밋 이후 검증·테스트·보고 절차가 수동으로 이뤄져 시간과 품질이 들쭉날쭉하다.
- SQL 튜닝, 코드 리팩토링, 보고서 작성은 경험 의존적이며 지식이 축적되지 않는다.
- Slack, Jira 등 협업 도구와 연결이 느슨해 히스토리 추적이 어렵다.
- 작은 핫픽스라도 배포 안정성, 테스트 결과, 코드 규약 준수 여부를 한 번에 확인하기 어렵다.

## 4. 목표 및 성공 지표
- **MVP 목표**: 단일 프로젝트(파이썬 기반)에서 커밋 후 자동 실행 → 코드 검증 → SQL 최적화 → 보고서 생성까지의 파이프라인 완성.
- **핵심 KPI**
  - 자동 생성 보고서 채택률 80% 이상 (일일/주간 회의에서 사용).
  - 커밋 이후 수동 테스트 시간 50% 감소.
  - SQL 검증 실패 시 조기 차단율 90% 이상.
  - Refactoring Agent가 제안한 수정의 사용자 승인율 70% 이상.

## 5. 대상 사용자 및 페르소나
- **백엔드 개발자 (주 페르소나)**: 빠르고 안정적인 배포가 필요, SQL 최적화에 부담.
- **데이터 엔지니어**: 복잡한 쿼리의 성능 검증이 빈번, 튜닝 히스토리가 필요.
- **QA/릴리즈 매니저**: 변경 사항과 테스트 결과를 한 눈에 보고싶지만 수집이 번거로움.
- **리더/PM**: 팀의 핫픽스 흐름, 위험 요소, 누적 이슈를 빠르게 파악하고 싶음.

## 6. 고객 가치 제안
1. **자동화된 커밋 파이프라인**: 커밋 이후의 검증·리포팅 과정을 버튼 한 번으로 자동화.
2. **데이터 기반 SQL 최적화**: LLM 기반 후보 쿼리 비교와 롤백 전략으로 성능 위험을 최소화.
3. **코드 품질 가디언**: 팀 규약과 아키텍처 가이드를 준수하는 리팩토링을 자동 제안.
4. **협업 보고 자동화**: Slack/보고서가 자동 생성되어 공유 흐름이 표준화.

## 7. 사용자 플로우

### 7.1 CLI 중심 시나리오
1. 개발자는 로컬에서 수정 후 `commitly init`으로 프로젝트를 활성화한다 (`.commitly/` 디렉토리 생성).
2. `commitly git add .` → `commitly git commit -m "<msg>"` 실행.
3. 커밋 이벤트를 트리거로 LangGraph 파이프라인이 자동 실행된다.
4. 각 에이전트의 결과가 CLI 터미널에 스트리밍되며, 사용자 승인이 필요한 단계(Code, Test, Refactoring, Sync)에서 입력을 기다린다.
5. Sync Agent 승인이 완료되면 원격 저장소 push 및 로컬 워킹 트리 반영이 자동 수행된다.
6. Slack Agent가 결과 요약을 팀 채널에 게시하고, Report Agent가 기간별 보고서를 업데이트한다.

### 7.2 VS Code 확장 시나리오
1. 사용자는 Commitly 확장을 설치한 후 명령 팔레트에서 `Commitly: Scan` 실행.
2. 확장은 백그라운드에서 `commitly` CLI를 실행하고 로그를 패널에 출력한다.
3. 중간 승인 요청은 VS Code 알림/입력 패널로 수집한다.
4. 완료 후 Slack 메시지 링크와 보고서 파일 경로를 패널에서 바로 확인한다.

## 8. 에이전트 오케스트레이션 개요
```
Clone → Code → (성공 시) Test → (성공 시) Refactoring → Sync → Slack → Report
```
- 모든 에이전트는 RunContext를 공유하며 `.commitly/hub` 허브 복제본에서 작업한다.
- 실패 시에는 해당 단계에서 중단하고 Sync/Slack/Report 단계에 실패 상태가 전달된다.

### 8.1 Clone Agent
- **트리거**: 커밋 직후.
- **입력**: `workspace_path`, `hub_path`, `git_remote`, 로컬 최신 커밋 diff.
- **핵심 기능**: 원격 저장소 최신 상태로 허브 동기화 → 로컬 커밋 패치 적용 → 무결성 검증 → JSON 결과 기록.
- **출력**: `clone_agent.json` (허브 HEAD, 적용 커밋, 변경 파일, 경고).

### 8.2 Code Agent
- **트리거**: Clone Agent 성공 시.
- **입력**: 허브 경로, `clone_agent.json`, 실행 환경 설정.
- **핵심 기능(MVP)**: 정적 점검(린트/타입) → `python main.py` 실행 → 오류 요약 → 사용자 승인 여부 수집.
- **출력**: `code_agent.json` (검사 결과, 오류, 다음 단계 플래그), 실행 로그, 요약 리포트.

### 8.3 Test Agent
- **트리거**: Code Agent 성공 후.
- **입력**: `code_agent.json`, `hasQuery` (Boolean), `queryFileList` (SQL 위치 JSON).
- **핵심 기능**:
  - `hasQuery == False`: 즉시 Refactoring Agent로 넘김.
  - `hasQuery == True`: 각 파일/함수/라인별로 SQL 파싱 → LLM으로 동등 기능 후보 쿼리 3~5개 생성 → `EXPLAIN` 비교 → 가장 효율적인 쿼리 적용(원본이 최적이면 유지) → `python main.py` 재실행 → 오류 발생 시 원본 복구 후 사용자에게 보고.
- **출력**: 최종 채택 쿼리, 실행 로그, 성능 비교 결과 `test_agent.json`.

### 8.4 Refactoring Agent
- **트리거**: Test Agent 성공 후.
- **핵심 기능**: 팀 아키텍처 가이드 기반으로 중복 제거, 예외 처리, 로그 개선 등을 제안/자동 적용 → 사용자 승인 루프.
- **출력**: 적용/제안된 변경 사항, 위반 규칙, 재실행 필요 여부 `refactoring_agent.json`.

### 8.5 Sync Agent
- **트리거**: Refactoring 완료 및 사용자 승인.
- **핵심 기능**: 허브 변경사항을 로컬 워킹 트리와 원격 저장소에 반영(pull-safe, push) → 결과 JSON 저장 → 표준 커밋 메시지 추천(`[hotfix] ...`).
- **출력**: `sync_agent.json` (push 여부, 원격 URL, 변경 파일, 요약 메시지).

### 8.6 Slack Agent
- **트리거**: Sync Agent 이후.
- **핵심 기능**: Sync/Code/Test/Refactoring JSON을 집계 → Slack 메시지 및 파일 매칭 → 채널/DM 전송 → 전송 내역 로그 저장.
- **출력**: Slack 메시지 ID, 전송 채널, 첨부 파일 매핑 `slack_agent.json`.

### 8.7 Report Agent
- **트리거**: Slack Agent 이후 또는 배치 실행.
- **핵심 기능**: Slack Agent 캐시를 읽어 기간별(일/주/월) 보고서를 Markdown/JSON으로 생성 → 로컬 `daily/`, `.commitly/reports/`에 저장.
- **출력**: 보고서 파일 경로, 생성 시각, 포함 커밋 리스트 `report_agent.json`.

## 9. 핵심 기능 요구사항
### 9.1 Git/Hub 오케스트레이션
- 허브 클론은 shallow clone을 사용하되, 필요 시 전체 히스토리 옵션 제공.
- 모든 변경은 허브에서만 이루어지며 Sync 승인 전까지 로컬 워킹 트리는 변하지 않는다.
- 충돌/패치 실패 시 사용자에게 파일 경로, 원인, 해결 옵션 제공.

### 9.2 코드 검증 및 실행
- MVP는 `python main.py` 실행을 기본으로 하며, 향후 프로젝트별 프로필을 지원한다.
- 정적 검사 실패 시 즉시 중단하고 로그를 제공한다.
- 실행 로그는 최대 5MB까지 저장하며, 초과 시 압축 후 경로만 안내한다.

### 9.3 SQL 최적화
- SQL 파싱은 기본 파이썬 AST + 정규식 조합으로 구현한다.
- `EXPLAIN` 실행은 로컬 Postgres (docker/postgres-compose.yaml 기반)를 기본으로 한다.
- 후보 쿼리 실행 시 오류가 발생하면 해당 후보를 제외하고 최대 3회까지 대체 후보를 요청한다.

### 9.4 리팩토링
- 팀 규칙은 `config/refactoring_rules.yaml`에서 정의하며, 미정이면 기본 템플릿을 사용.
- 자동 수정 전 사용자 승인 옵션 제공(스킵 가능).
- Refactoring Agent가 제안만 하고 수동 확인을 기다리는 모드도 지원한다.

### 9.5 동기화/배포
- Sync는 push 전 사용자 확인을 반드시 거친다.
- push 실패(권한, 네트워크) 시 재시도 옵션과 수동 push 안내 제공.

### 9.6 보고·알림
- Slack 메시지는 요약, 테스트 결과, SQL 최적화 비교, 리팩토링 하이라이트를 포함.
- Report Agent는 기간 필터, 커밋 범위 지정, CSV/Markdown 두 가지 포맷을 기본 제공.

## 10. 설정 및 사용자 인터페이스
- 주요 설정 파일
  - `.env`: API 키, DB DSN, Slack 토큰, `COMMITLY_HUB_ROOT`.
  - `config/models.yaml`: LLM 모델명, 온도, 토큰 한도.
  - `config/code_agent.yaml`: 정적 검사 명령, 실행 프로필(향후 확장).
  - `config/test_agent.yaml`: DB 연결, 후보 쿼리 생성 옵션.
- CLI UX
  - `commitly init`: 프로젝트 등록.
  - `commitly status`: 최신 실행 결과 요약.
  - `commitly restore`: 실패 시 허브 스냅샷을 워킹 트리에 적용(향후 확장).
- VS Code UX
  - 상태 패널: 현재 실행 단계, 로그, 사용자 입력 모달.
  - 설정 UI: Slack 채널, 테스트 타임아웃, 리포트 저장 경로.

## 11. 비기능 요구사항
- 모든 에이전트는 로컬에서만 동작하며 외부 네트워크 접근은 없거나 최소화.
- 실행 시간: 커밋부터 보고서 생성까지 기본 5분 내(대규모 테스트 제외).
- 로깅: `.commitly/logs/<agent>/<timestamp>.log` 구조, JSONL 포맷.
- 확장성: LangGraph DAG를 재구성해 에이전트 추가/삭제가 용이해야 한다.
- 오류 복원력: 단계 실패 시 허브 상태를 보존하고, 재실행 시 증분 처리.

## 12. 데이터 및 보안
- 로컬 디스크만 사용, 민감 정보는 `.env` 기반으로 암호화 저장 옵션 제공.
- Slack 토큰 등 비밀 정보는 OS 키체인 연동 옵션 제공(향후).
- 로그는 30일 보관 후 자동 정리(옵션).

## 13. MVP 범위 정의
- 대상 언어: Python (추후 Node, Java 확장 예정).
- 실행 명령: `python main.py`.
- SQL DB: Postgres 단일 인스턴스.
- Slack 알림: Webhook 기반 기본 메시지 전송.
- 보고서: 일일 보고서(Markdown) 자동 생성.
- VS Code 확장: 로그 스트리밍 + 사용자 입력 지원.

## 14. 향후 확장 로드맵
1. **Auto Change Impact Brief**: Code Agent에서 영향 모듈·테이블·API 리스트를 추출해 Slack과 보고서에 첨부.
2. **SQL 개선 위키화**: Test Agent 결과를 지식 베이스에 축적, 유사 패턴 감지 시 자동 제안.
3. **안전망 브랜치 자동화**: 실패 시 임시 브랜치/스냅샷을 생성해 `commitly restore` 명령으로 복구.
4. **QA 티켓 생성**: 영향도 기반으로 Jira/Asana 티켓을 자동 등록.
5. **Refactoring 규칙 학습**: 사용자 거부 데이터를 축적해 규칙을 자동 조정.
6. **대시보드/리포트 패널**: Slack/Report 데이터를 시각화해 릴리즈 리더용 웹 패널 제공.

## 15. 리스크 및 대응
- **LLM 의존성**: 네트워크/모델 장애 시 대비해 기본 규칙 기반 fallback 제공.
- **DB 연결 실패**: 로컬 Postgres 기동 실패 시 사용자에게 docker 실행 가이드 제공 후 재시도.
- **사용자 승인 피로도**: 승인 요청이 잦으면 자동 승인 정책(신뢰 등급 기반)을 도입.
- **대용량 로그**: 로그 크기 제한 초과 시 압축, 저장 위치 안내.

## 16. 오픈 이슈
- 멀티 프로젝트 동시 실행 시 허브 경로 충돌 여부 검토 필요.
- VS Code와 CLI 간 설정 동기화 방식 결정 필요.
- Slack 메시지 템플릿, 요약 구조 최종 확정.
- Refactoring Agent 규칙 세트 초안 마련 필요.

---
본 PRD는 Commitly MVP를 신속히 구현하기 위한 기준 문서이며, 실행 중 발견되는 요구사항은 각 스프린트 회고에서 업데이트한다.
